rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection
    match /users/{userId} {
      // Allow read access to all authenticated users
      allow read: if request.auth != null;

      // Allow write access only to the user's own document
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Profile Views collection
    match /profileViews/{viewId} {
      // Allow authenticated users to read views where they are the viewer OR the viewed user
      allow read: if request.auth != null &&
                     (resource.data.viewedUserId == request.auth.uid ||
                      resource.data.viewerId == request.auth.uid);

      // Allow authenticated users to create views (recording when they view someone)
      allow create: if request.auth != null &&
                       request.resource.data.viewerId == request.auth.uid;

      // Allow users to update their own view records (marking as read)
      allow update: if request.auth != null &&
                       resource.data.viewedUserId == request.auth.uid;

      // Allow users to delete old views if they own them
      allow delete: if request.auth != null &&
                       resource.data.viewedUserId == request.auth.uid;
    }

    // Chat Rooms collection
    match /chatRooms/{chatRoomId} {
      // Allow creating new chatRooms
      allow create: if request.auth != null &&
                       request.auth.uid in request.resource.data.participants;

      // Users can read/write chatRooms they are participants in
      allow read, write: if request.auth != null &&
                            (request.auth.uid in resource.data.participants);
    }

    // Messages subcollection
    match /chatRooms/{chatRoomId}/messages/{messageId} {
      // Users can read messages in chatRooms they are participants in
      allow read: if request.auth != null &&
                     request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatRoomId)).data.participants;

      // Users can create messages in chatRooms they are participants in
      // with validation for message content
      allow create: if request.auth != null &&
                       request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatRoomId)).data.participants &&
                       request.resource.data.senderId == request.auth.uid &&
                       request.resource.data.message is string &&
                       request.resource.data.message.size() <= 5000 &&
                       request.resource.data.timestamp is timestamp &&
                       request.resource.data.senderId is string &&
                       request.resource.data.receiverId is string;

      // No updates or deletes on messages
      allow update, delete: if false;
    }

    // Matches collection
    match /matches/{matchId} {
      // Users can read/write matches they are part of
      allow read, write: if request.auth != null &&
                            (resource.data.userId1 == request.auth.uid ||
                             resource.data.userId2 == request.auth.uid);

      // Allow creating matches
      allow create: if request.auth != null &&
                       (request.resource.data.userId1 == request.auth.uid ||
                        request.resource.data.userId2 == request.auth.uid);
    }

    // Default: deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
